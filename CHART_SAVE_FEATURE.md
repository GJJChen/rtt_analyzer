# 图表保存功能已优化

## 问题分析

**原问题：**
- 工具栏右上角的"保存为图片"按钮点击无反应
- 因为 ECharts 的 `saveAsImage` 功能在 Tauri 桌面应用中，浏览器下载行为受到限制

## 解决方案

### 已实现功能

#### 1. **新增"保存图表"按钮** ✅
- **位置**：CDF 分析标签页右上角（绿色按钮）
- **功能**：点击后打开文件保存对话框，可以选择保存位置和文件名
- **特点**：
  - 使用 Tauri 原生文件对话框
  - 自动生成带时间戳的文件名
  - 支持自定义保存位置
  - 高清晰度（2倍像素密度）
  - 自动适配亮色/暗色背景
  - 保存的图片不包含工具栏和缩放控件

#### 2. **自动保存功能**（已有） ✅
- 分析完成后自动保存到结果文件夹
- 文件位置：`{输出目录}/{文件名}_results/{文件名}_cdf.png`
- 无需手动操作

### 使用方法

#### 手动保存图表
1. 拖入 CSV 文件并完成分析
2. 在"CDF 分析"标签页，点击右上角绿色的"保存图表"按钮
3. 在弹出的保存对话框中选择保存位置
4. 点击"保存"即可

#### 自动保存的图表位置
- 每次分析完成，图表会自动保存到结果文件夹
- 可以直接在文件管理器中查看

### 技术实现

```javascript
// 使用 Tauri 的文件系统 API
import { save } from '@tauri-apps/plugin-dialog';
import { writeFile } from '@tauri-apps/plugin-fs';

// 保存图表的函数
const handleManualSaveChart = async () => {
  // 1. 从 ECharts 实例获取图表数据（base64）
  const imageData = echartsInstance.getDataURL({
    type: 'png',
    pixelRatio: 2, // 高清
    backgroundColor: darkMode ? '#1f2937' : '#ffffff',
    excludeComponents: ['toolbox', 'dataZoom'] // 排除UI控件
  });
  
  // 2. 转换为字节数组
  const bytes = base64ToUint8Array(imageData);
  
  // 3. 打开保存对话框
  const filePath = await save({
    defaultPath: `${baseName}_cdf_${timestamp}.png`,
    filters: [{ name: 'PNG 图片', extensions: ['png'] }]
  });
  
  // 4. 写入文件
  if (filePath) {
    await writeFile(filePath, bytes);
  }
};
```

### 按钮样式

- **绿色渐变背景**：醒目易识别
- **下载图标**：直观表示功能
- **响应式**：小屏幕只显示图标，大屏幕显示"保存图表"文字
- **悬停效果**：阴影增强，提供视觉反馈

### 与工具栏按钮的区别

| 功能 | 工具栏保存按钮 | 新增保存按钮 |
|------|--------------|------------|
| **位置** | 图表内右上角 | 标签页右上角 |
| **工作方式** | ECharts 内置（浏览器下载） | Tauri 文件对话框 |
| **Tauri 兼容性** | ❌ 不可靠 | ✅ 完全支持 |
| **自定义保存位置** | ❌ 只能下载到默认文件夹 | ✅ 可选择任意位置 |
| **文件名** | 固定 | ✅ 带时间戳，可自定义 |
| **推荐使用** | 否 | **是** |

### 下一步

工具栏的"保存为图片"按钮可以考虑：
1. **保留**：作为备用选项（在某些环境下可能仍然有效）
2. **移除**：避免用户混淆，只保留新按钮
3. **替换**：将工具栏按钮的功能改为调用新的保存函数

**建议**：保留工具栏按钮，因为有些用户习惯从那里保存。如果点击无效，用户会自然地尝试新按钮。

## 总结

✅ **新增了可靠的保存图表按钮**
✅ **使用 Tauri 原生 API，完全兼容桌面应用**
✅ **支持自定义保存位置和文件名**
✅ **保留自动保存功能，双重保障**
✅ **用户体验优化，操作简单直观**

现在您可以：
- 点击绿色"保存图表"按钮手动保存
- 或者在结果文件夹中查看自动保存的图表
- 两种方式都能获得高质量的 PNG 图片
